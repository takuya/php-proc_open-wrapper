<?php

namespace Tests\Feature\ProcOpen;

use Tests\TestCase;
use Takuya\ProcOpen\ProcOpen;

class DetachFromProcOpenTest extends TestCase {
  public function test_process_detach_from_while_loop () {
    if (PHP_OS !== 'Linux' ){$this->assertNull(null);return;}
    
    $proc = new ProcOpen( ['php'], __DIR__, ['SHELL' => 'php'] );
    $proc->setInput(<<<'EOS'
      <?php
      usleep(200);
      EOS);
    $proc->start();
    $pid = $proc->info->pid;
    try{
      $proc->wait(function() use($proc) {
        throw new \RuntimeException('detach by exception.');
      });
    }catch (\Exception $e){
      $this->assertEquals('detach by exception.', $e->getMessage());
    }
    
    $this->assertTrue(proc_get_status($proc->info->getProcResource())['running']);
    while (proc_get_status($proc->info->getProcResource())['running']){
      $ret = posix_getsid($pid);
      $this->assertNotFalse($ret);
      usleep(100);
    }
    
  }
}