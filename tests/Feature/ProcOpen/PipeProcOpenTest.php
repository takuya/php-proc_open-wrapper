<?php

namespace ProcOpen;

use Tests\TestCase;
use Takuya\ProcOpen\ProcOpen;

class PipeProcOpenTest extends TestCase {
  public function test_proc_open_pipe_to_proc_open () {
    if (PHP_OS !== 'Linux' ){$this->assertNull(null);return;}
    
    $proc1 = new ProcOpen( ['php'], __DIR__, ['SHELL' => 'php'] );
    $proc1->setInput(<<<'EOS'
      <?php
      foreach(range(1,100) as $i){
        echo 'a'.PHP_EOL;
      }
      EOS);
    $proc1->start();
    $proc2 = new ProcOpen(['wc','-l'],__DIR__,["SHELL"=>'php'],$proc1->getFd(1));
    $proc2->start();
    $out= stream_get_contents($proc2->getFd(1));
    
    $this->assertEquals('100',trim($out));

  }
}